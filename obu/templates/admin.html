{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä - Obuv</title>
    <link rel="stylesheet" href="{% static 'sty.css' %}">
    <link rel="icon" href="{% static 'images/icon.png' %}" type="image/png">

</head>
<body>
    <header>
        <div class="header-left">
            <img src="{% static 'images/icon.png' %}" alt="–õ–æ–≥–æ—Ç–∏–ø" class="header-logo">
            <h1>–ú–∞–≥–∞–∑–∏–Ω –æ–±—É–≤–∏</h1>
        </div>
        <div class="header-right">
            <span>{{ request.session.user_full_name }} (–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)</span>
            <a href="{% url 'logout' %}">–í—ã–π—Ç–∏</a>
        </div>
    </header>

    <!-- –°–µ–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ -->
    <div class="search-section">
        <form method="get" class="search-form">
            <input type="text"
                   name="q"
                   class="search-input"
                   placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É, –Ω–∞–∑–≤–∞–Ω–∏—é, –æ–ø–∏—Å–∞–Ω–∏—é..."
                   value="{{ query }}">

            <!-- –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É -->
            <input type="hidden" name="provider" value="{{ selected_provider }}">
            <input type="hidden" name="sort" value="{{ sort_by }}">

            <button type="submit" class="search-button">–ù–∞–π—Ç–∏</button>
            {% if query %}
                <a href="?{% if sort_by %}sort={{ sort_by }}&{% endif %}{% if selected_provider and selected_provider != 'all' %}provider={{ selected_provider }}{% endif %}" class="clear-button">–°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∏—Å–∫</a>
            {% endif %}
        </form>

        {% if query %}
        <div class="search-results">
            –ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: {{ products|length }} –ø–æ –∑–∞–ø—Ä–æ—Å—É "{{ query }}"
        </div>
        {% endif %}
    </div>

    <!-- –°–µ–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É -->
    <div class="filter-section">
        <span class="filter-title">–§–∏–ª—å—Ç—Ä –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É:</span>
        <form method="get" class="filter-form" id="filter-form">
            <select name="provider" class="filter-select" onchange="document.getElementById('filter-form').submit()">
                <option value="all" {% if selected_provider == 'all' or not selected_provider %}selected{% endif %}>
                    üîÑ –í—Å–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏
                </option>
                {% for provider in providers %}
                    <option value="{{ provider.id }}" {% if selected_provider|stringformat:"s" == provider.id|stringformat:"s" %}selected{% endif %}>
                        {{ provider.provider_name }}
                    </option>
                {% endfor %}
            </select>

            <!-- –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∏—Å–∫ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É -->
            <input type="hidden" name="q" value="{{ query }}">
            <input type="hidden" name="sort" value="{{ sort_by }}">

            {% if selected_provider and selected_provider != 'all' %}
                <a href="?{% if query %}q={{ query }}&{% endif %}{% if sort_by %}sort={{ sort_by }}{% endif %}" class="clear-filter">‚úï –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</a>
            {% endif %}
        </form>
    </div>

    <!-- –°–µ–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ -->
    <div class="sort-section">
        <span class="sort-title">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –Ω–∞ —Å–∫–ª–∞–¥–µ:</span>
        <div class="sort-links">
            <a href="?{% if query %}q={{ query }}&{% endif %}{% if selected_provider and selected_provider != 'all' %}provider={{ selected_provider }}&{% endif %}sort=stock_asc"
               class="sort-link {% if sort_by == 'stock_asc' %}active{% endif %}">
                üìà –ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é <span class="arrow">‚Üë</span>
            </a>
            <a href="?{% if query %}q={{ query }}&{% endif %}{% if selected_provider and selected_provider != 'all' %}provider={{ selected_provider }}&{% endif %}sort=stock_desc"
               class="sort-link {% if sort_by == 'stock_desc' %}active{% endif %}">
                üìâ –ü–æ —É–±—ã–≤–∞–Ω–∏—é <span class="arrow">‚Üì</span>
            </a>
            <a href="?{% if query %}q={{ query }}&{% endif %}{% if selected_provider and selected_provider != 'all' %}provider={{ selected_provider }}{% endif %}"
               class="sort-link {% if sort_by == 'default' or not sort_by %}active{% endif %}">
                –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
            </a>
        </div>
    </div>

<!-- –í—ã–≤–æ–¥ —Ç–æ–≤–∞—Ä–æ–≤ -->
{% for prod in products %}
<div class="product-card {% if prod.discount_percent > 15 %}high-discount{% endif %}">
    <!-- –§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ -->
    <div class="product-image">
        {% if prod.photo %}
            <img src="{% static 'images/' %}{{ prod.photo }}" alt="{{ prod.product_name }}">
        {% else %}
            <div class="no-image">
                <img src="{% static 'images/picture.png' %}" width="100" height="100">
            </div>
        {% endif %}
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
    <div class="product-info">
        <div><b>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</b> {{ prod.category.category_name }}</div>
        <div><b>–ê—Ä—Ç–∏–∫—É–ª:</b> {{ prod.article}}</div>
        <div><b>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</b> {{ prod.product_name }}</div>
        <div><b>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:</b> {{ prod.producer.producer_name }}</div>
        <div><b>–ü–æ—Å—Ç–∞–≤—â–∏–∫:</b> {{ prod.provider.provider_name }}</div>
        <div><b>–ï–¥. –∏–∑–º–µ—Ä–µ–Ω–∏—è:</b> {{ prod.unit.unit_name }}</div>

        <div>
            <b>–¶–µ–Ω–∞:</b>
            {% if prod.discount_percent > 0 %}
                <span class="price-old">{{ prod.price|floatformat:2 }} —Ä—É–±.</span>
                <span class="price-new">{{ prod.discounted_price|floatformat:2 }} —Ä—É–±.</span>
            {% else %}
                <span class="price-new">{{ prod.price|floatformat:2 }} —Ä—É–±.</span>
            {% endif %}
        </div>

        <div>
            <b>–ù–∞ —Å–∫–ª–∞–¥–µ:</b>
            {% if prod.stock_quantity == 0 %}
                <span class="out-of-stock">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
            {% elif prod.stock_quantity < 5 %}
                <span style="color: #ff9800; font-weight: bold;">{{ prod.stock_quantity }} —à—Ç. (–æ—Å—Ç–∞–ª–æ—Å—å –º–∞–ª–æ)</span>
            {% else %}
                <span style="font-weight: bold;">{{ prod.stock_quantity }} —à—Ç.</span>
            {% endif %}
        </div>

        <!-- –û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ -->
        {% if prod.description %}
        <div style="grid-column: span 2; margin-top: 10px; font-style: italic; color: #666;">
            {{ prod.description }}
        </div>
        {% endif %}

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–í–ù–£–¢–†–ò –¶–ò–ö–õ–ê) -->
        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <a href="{% url 'product_edit' prod.id %}" class="btn-edit" style="
                padding: 8px 15px;
                background-color: #ffbb33;
                color: #000;
                text-decoration: none;
                border-radius: 5px;
                font-weight: bold;
                display: inline-block;
            ">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>

            <form method="post" action="{% url 'product_delete' prod.id %}" style="display: inline;"
                  onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.');">
                {% csrf_token %}
                <button type="submit" style="
                    padding: 8px 15px;
                    background-color: #ff4444;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    font-weight: bold;
                    cursor: pointer;
                ">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </form>
        </div>
    </div>

    {% if prod.discount_percent > 0 %}
    <div class="discount-badge">
        -{{ prod.discount_percent }}%
    </div>
    {% endif %}
</div>
{% empty %}
<div class="empty-catalog">
    <h3>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
    {% if query or selected_provider %}
    <p style="margin-top: 10px; color: #666;">
        –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä–∞
    </p>
    {% endif %}
</div>
{% endfor %}
</body>
</html>
